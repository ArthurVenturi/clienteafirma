#!/bin/sh


# Ensure the AutoFirma directory exists
mkdir -p /usr/lib/AutoFirma

# Extract autofirmaConfigurador.jar if not present
if [ ! -f "/usr/lib/AutoFirma/autofirmaConfigurador.jar" ]; then
    # Try to extract or copy from a known location in the package
    if [ -f "/tmp/autofirmaConfigurador.jar" ]; then
        cp /tmp/autofirmaConfigurador.jar /usr/lib/AutoFirma/
    elif [ -f "/usr/share/AutoFirma/autofirmaConfigurador.jar" ]; then
        cp /usr/share/AutoFirma/autofirmaConfigurador.jar /usr/lib/AutoFirma/
    else
        echo "ERROR: autofirmaConfigurador.jar not found. Installation cannot continue."
        exit 1
    fi
fi

# generamos certificado CA y SSL
java -jar /usr/lib/AutoFirma/autofirmaConfigurador.jar
# damos permiso al script de instalacion del certificado para firefox y lo ejecutamos

echo "Generacion de certificados"

if [ -f "/usr/lib/AutoFirma/script.sh" ]; then
    chmod +x /usr/lib/AutoFirma/script.sh
    /usr/lib/AutoFirma/script.sh
fi

echo "Instalacion del certificado CA en el almacenamiento de Firefox y Chrome"

#Creacion de certificado .pem y .crt para su importacion en el almacenamiento del sistema
openssl x509 -inform der -in /usr/lib/AutoFirma/Autofirma_ROOT.cer -out /usr/lib/AutoFirma/Autofirma_ROOT.pem

mv /usr/lib/AutoFirma/Autofirma_ROOT.pem /usr/lib/AutoFirma/Autofirma_ROOT.crt

cp /usr/lib/AutoFirma/Autofirma_ROOT.crt /usr/share/ca-certificates/Autofirma/Autofirma_ROOT.crt
cp /usr/lib/AutoFirma/Autofirma_ROOT.crt /usr/local/share/ca-certificates/Autofirma_ROOT.crt
update-ca-certificates
echo "Instalacion del certificado CA en el almacenamiento del sistema"

# Enlazamos el fichero de asociacion del protocolo "afirma" en Firefox
# para que aplique a otros navegadores
if [ -d /etc/icecat ] ; then
   if [ ! -d /etc/icecat/pref ] ; then
      mkdir /etc/icecat/pref
   fi
   ln -s /etc/firefox/pref/Autofirma.js /etc/icecat/pref/Autofirma.js
fi
if [ -d /etc/firefox-esr ] ; then
   if [ ! -d /etc/firefox-esr/pref ] ; then
      mkdir /etc/firefox-esr/pref
   fi
   ln -s /etc/firefox/pref/Autofirma.js /etc/firefox-esr/pref/Autofirma.js
fi

exit 0